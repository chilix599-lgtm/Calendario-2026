<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda 26</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        
        .controls { 
            position: sticky; top: 10px; background: white; padding: 15px; 
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center; gap: 15px; z-index: 100;
            margin-bottom: 30px;
        }

        .search-input { padding: 8px 12px; border: 2px solid #ddd; border-radius: 20px; outline: none; width: 200px; }

        /* D√≠a de Hoy: Fondo azul */
        .today { 
            background-color: #007bff !important; 
            color: white !important; 
            border: 2px solid #0056b3 !important;
            box-shadow: 0 4px 10px rgba(0,123,255,0.4);
        }
        .today .day-preview, .today .weather-info { color: white !important; }

        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .month { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .month-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day { border: 1px solid #f0f0f0; min-height: 75px; padding: 6px; cursor: pointer; border-radius: 6px; position: relative; }
        .day-number { font-weight: bold; font-size: 0.9rem; }
        
        /* Estilo del clima */
        .weather-info { font-size: 1.2rem; text-align: right; margin-top: -5px; }
        .temp-small { font-size: 0.6rem; display: block; opacity: 0.9; }

        .day-preview { font-size: 0.7rem; color: #666; margin-top: 4px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; }
        .modal-textarea { width: 100%; height: 120px; border-radius: 8px; padding: 10px; box-sizing: border-box; resize: none; border: 1px solid #ddd; }
        .btn-save { width: 100%; margin-top: 10px; padding: 10px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üìÖ Calendario 2026</h1>

    <div class="controls">
        <input type="text" id="searchInput" class="search-input" placeholder="Buscar notas..." oninput="renderCalendar()">
        <button onclick="window.print()" style="cursor:pointer; padding: 8px 15px; border-radius: 8px; border:none; background:#28a745; color:white;">üñ®Ô∏è PDF</button>
    </div>

    <div id="calendar" class="calendar-grid"></div>

    <div id="dayModal" class="modal">
        <div class="modal-content">
            <h3 id="modalDate"></h3>
            <textarea id="modalText" class="modal-textarea"></textarea>
            <button class="btn-save" onclick="saveFromModal()">Guardar</button>
        </div>
    </div>

    <script>
        const months = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const dayNames = ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"];
        let currentDayId = null;
        let weatherData = { icon: "‚åõ", temp: "--" };

        // 1. FUNCI√ìN PARA BUSCAR CLIMA REAL POR INTERNET (Open-Meteo)
        async function fetchRealWeather() {
            try {
                // Coordenadas aproximadas de El Palmar/Murcia
                const lat = 37.94; 
                const lon = -1.16;
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const data = await response.json();
                const code = data.current_weather.weathercode;
                
                // Mapeo simple de c√≥digos de Open-Meteo a Emojis
                const icons = {
                    0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è", 
                    45: "üå´Ô∏è", 51: "üå¶Ô∏è", 61: "üåßÔ∏è", 71: "‚ùÑÔ∏è", 95: "‚õàÔ∏è"
                };
                
                weatherData.icon = icons[code] || (code > 60 ? "üåßÔ∏è" : "‚òÄÔ∏è");
                weatherData.temp = Math.round(data.current_weather.temperature) + "¬∞C";
                renderCalendar(); // Re-renderizar para mostrar el clima obtenido
            } catch (e) {
                console.error("Error al obtener clima:", e);
                weatherData.icon = "‚òÅÔ∏è";
            }
        }

        function load() { return JSON.parse(localStorage.getItem('cal2026') || '{}'); }
        function save(id, value) {
            const data = load();
            if (!data[id]) data[id] = {};
            data[id].text = value;
            localStorage.setItem('cal2026', JSON.stringify(data));
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            const query = document.getElementById('searchInput').value.toLowerCase();
            const savedData = load();
            const today = new Date();

            months.forEach((monthName, monthIndex) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month';
                
                let html = `<div class="month-header"><strong>${monthName}</strong></div><div class="days-grid">`;
                dayNames.forEach(d => html += `<div style="font-size:0.7rem; color:#bbb; text-align:center">${d}</div>`);

                const firstDay = new Date(2026, monthIndex, 1).getDay();
                const daysInMonth = new Date(2026, monthIndex + 1, 0).getDate();

                for (let i = 0; i < firstDay; i++) html += `<div></div>`;

                for (let d = 1; d <= daysInMonth; d++) {
                    const id = `${monthIndex}-${d}`;
                    const note = savedData[id]?.text || '';
                    const isToday = (today.getFullYear() === 2026 && today.getMonth() === monthIndex && today.getDate() === d);
                    
                    if (query && !note.toLowerCase().includes(query)) continue;

                    html += `
                        <div class="day ${isToday ? 'today' : ''}" onclick="openModal('${id}', '${d} de ${monthName}')">
                            <div style="display:flex; justify-content:space-between">
                                <span class="day-number">${d}</span>
                                ${isToday ? `<div class="weather-info">${weatherData.icon}<span class="temp-small">${weatherData.temp}</span></div>` : ''}
                            </div>
                            <div class="day-preview">${note}</div>
                        </div>`;
                }
                html += `</div>`;
                monthDiv.innerHTML = html;
                container.appendChild(monthDiv);
            });
        }

        function openModal(id, date) {
            currentDayId = id;
            document.getElementById('modalDate').innerText = date;
            document.getElementById('modalText').value = load()[id]?.text || '';
            document.getElementById('dayModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('dayModal').style.display = 'none'; renderCalendar(); }
        function saveFromModal() { save(currentDayId, document.getElementById('modalText').value); closeModal(); }
        
        window.onclick = (e) => { if (e.target.id == 'dayModal') closeModal(); }

        // Iniciar aplicaci√≥n
        fetchRealWeather();
        renderCalendar();
    </script>
</body>
</html>
