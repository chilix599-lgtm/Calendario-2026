<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAgenda</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; margin: 0; }
        
        /* Banner de Bienvenida / Alertas */
        #notification-banner {
            background: #007bff; color: white; padding: 15px; text-align: center;
            position: sticky; top: 0; z-index: 1001; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-radius: 0 0 15px 15px;
        }
        #notification-banner button {
            background: white; color: #007bff; border: none; padding: 8px 15px;
            border-radius: 5px; font-weight: bold; cursor: pointer; margin-left: 10px;
        }

        /* Clima */
        #weather-header { text-align: center; padding: 10px; font-weight: bold; color: #555; }

        .controls { 
            background: white; padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; 
            flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0;
        }

        /* Grid de Calendario */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .month { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .month-title { text-align: center; font-weight: bold; text-transform: capitalize; margin-bottom: 10px; border-bottom: 2px solid #eee; }
        
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-header { text-align: center; font-size: 0.7rem; color: #999; font-weight: bold; }
        
        .day { 
            border: 1px solid #f0f0f0; min-height: 60px; padding: 5px; 
            border-radius: 5px; cursor: pointer; position: relative; font-size: 0.8rem;
        }
        .day.holiday { background-color: #fff4e5; border: 1px solid #ffcc80; }
        .holiday-name { font-size: 0.6rem; color: #e67e22; display: block; margin-top: 2px; line-height: 1; }
        .day-preview { font-size: 0.65rem; color: #666; margin-top: 4px; font-style: italic; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; padding: 10px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; }
        .btn-save { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }

        @media print { #notification-banner, .controls { display: none !important; } }
    </style>
</head>
<body>

    <div id="notification-banner">
        ðŸ“¢ Â¡Hola! Para no olvidar tus tareas, activa las notificaciones de las 19:00h.
        <button onclick="enableNotifications()">Activar ahora</button>
    </div>

    <div id="weather-header">Cargando clima...</div>
    <h1 style="text-align: center;">Calendario 2026</h1>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="ðŸ” Buscar notas..." oninput="renderCalendar()" style="padding:8px; border-radius:20px; border:1px solid #ddd; width:200px;">
        <div style="display:flex; gap:10px; align-items:center;">
            <span>Color:</span>
            <div onclick="selectedColor='white'" style="width:20px; height:20px; background:white; border:1px solid #ccc; cursor:pointer;"></div>
            <div onclick="selectedColor='#d4edda'" style="width:20px; height:20px; background:#d4edda; cursor:pointer;"></div>
            <div onclick="selectedColor='#f8d7da'" style="width:20px; height:20px; background:#f8d7da; cursor:pointer;"></div>
        </div>
        <button onclick="window.print()" style="cursor:pointer; padding:5px 15px; border-radius:5px; border:1px solid #999;">Imprimir</button>
    </div>

    <div id="calendar" class="calendar-grid"></div>

    <div id="dayModal" class="modal">
        <div class="modal-content">
            <h3 id="modalDate" style="margin-top:0;"></h3>
            <p id="modalHolidayDesc" style="color: #e67e22; font-size: 0.9rem; margin-top: -10px;"></p>
            <textarea id="modalText"></textarea>
            <button class="btn-save" onclick="saveData()">Guardar nota</button>
        </div>
    </div>

    <script>
        let selectedColor = 'white';
        let currentDayId = null;
        const months = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const holidays = {
            "0-1": "AÃ±o Nuevo", "0-6": "Reyes Magos", "3-3": "Viernes Santo", "4-1": "DÃ­a del Trabajo",
            "7-15": "AsunciÃ³n", "9-12": "Fiesta Nacional", "10-1": "Todos los Santos",
            "11-6": "ConstituciÃ³n", "11-8": "Inmaculada", "11-25": "Navidad"
        };

        // --- CLIMA ---
        async function getClima() {
            try {
                const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=40.41&longitude=-3.70&current_weather=true');
                const d = await r.json();
                document.getElementById('weather-header').innerText = `Madrid: ${d.current_weather.temperature}Â°C`;
            } catch(e) { document.getElementById('weather-header').innerText = "Clima no disponible"; }
        }
        setInterval(getClima, 3600000);
        getClima();

        // --- NOTIFICACIONES ---
        function checkNotificationStatus() {
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                document.getElementById('notification-banner').style.display = 'block';
            }
        }

        async function enableNotifications() {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                document.getElementById('notification-banner').style.display = 'none';
                new Notification("Â¡Excelente!", { body: "Te avisarÃ© cada dÃ­a a las 19:00 si tienes tareas." });
            }
        }

        setInterval(() => {
            const ahora = new Date();
            // Verifica a las 19:00:00
            if (ahora.getHours() === 19 && ahora.getMinutes() === 0) {
                const maÃ±ana = new Date();
                maÃ±ana.setDate(ahora.getDate() + 1);
                const idMaÃ±ana = `${maÃ±ana.getMonth()}-${maÃ±ana.getDate()}`;
                const datos = JSON.parse(localStorage.getItem('cal2026') || '{}');
                
                if (datos[idMaÃ±ana] && datos[idMaÃ±ana].text) {
                    new Notification("Agenda para maÃ±ana", { body: `MaÃ±ana tienes: ${datos[idMaÃ±ana].text}` });
                }
            }
        }, 60000);

        // --- CALENDARIO ---
        function renderCalendar() {
            const container = document.getElementById('calendar');
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const savedData = JSON.parse(localStorage.getItem('cal2026') || '{}');
            container.innerHTML = '';

            months.forEach((name, idx) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month';
                monthDiv.innerHTML = `<div class="month-title">${name}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'days-grid';
                ["D", "L", "M", "X", "J", "V", "S"].forEach(h => grid.innerHTML += `<div class="day-header">${h}</div>`);

                const firstDay = new Date(2026, idx, 1).getDay();
                const totalDays = new Date(2026, idx + 1, 0).getDate();

                for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

                for(let d=1; d<=totalDays; d++) {
                    const id = `${idx}-${d}`;
                    const holiday = holidays[id];
                    const info = savedData[id] || {};
                    const matches = !searchQuery || (info.text && info.text.toLowerCase().includes(searchQuery));

                    const dayDiv = document.createElement('div');
                    dayDiv.className = `day ${holiday ? 'holiday' : ''}`;
                    dayDiv.style.backgroundColor = info.color || 'white';
                    dayDiv.style.opacity = matches ? "1" : "0.2";
                    
                    dayDiv.innerHTML = `
                        <b>${d}</b>
                        ${holiday ? `<span class="holiday-name">${holiday}</span>` : ''}
                        <div class="day-preview">${info.text ? info.text.substring(0, 15) + '...' : ''}</div>
                    `;
                    dayDiv.onclick = () => openModal(id, `${d} de ${name}`, holiday);
                    grid.appendChild(dayDiv);
                }
                monthDiv.appendChild(grid);
                container.appendChild(monthDiv);
            });
        }

        function openModal(id, dateStr, holiday) {
            currentDayId = id;
            const data = JSON.parse(localStorage.getItem('cal2026') || '{}');
            document.getElementById('modalDate').innerText = dateStr;
            document.getElementById('modalHolidayDesc').innerText = holiday ? `ðŸŽ‰ ${holiday}` : "";
            document.getElementById('modalText').value = data[id]?.text || "";
            document.getElementById('dayModal').style.display = 'flex';
        }

        function saveData() {
            const data = JSON.parse(localStorage.getItem('cal2026') || '{}');
            if(!data[currentDayId]) data[currentDayId] = {};
            data[currentDayId].text = document.getElementById('modalText').value;
            data[currentDayId].color = selectedColor;
            localStorage.setItem('cal2026', JSON.stringify(data));
            document.getElementById('dayModal').style.display = 'none';
            renderCalendar();
        }

        window.onclick = (e) => { if(e.target.className === 'modal') document.getElementById('dayModal').style.display = 'none'; }
        
        checkNotificationStatus();
        renderCalendar();
    </script>
</body>
</html>
